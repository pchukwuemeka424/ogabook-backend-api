<%- include('partials/header', { title: 'Subscription - OgaBook' }) %>

<style>
    * {
        box-sizing: border-box;
    }

    .subscription-container {
        min-height: 100vh;
        background: #f5f7fa;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px;
    }

    .subscription-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        max-width: 700px;
        width: 100%;
        overflow: hidden;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .subscription-header {
        background: white;
        border-bottom: 1px solid #e5e7eb;
        padding: 20px 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .header-icon {
        width: 40px;
        height: 40px;
        background: #10b981;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 20px;
        flex-shrink: 0;
    }

    .header-content h1 {
        font-size: 1.25rem;
        font-weight: 700;
        color: #111827;
        margin: 0;
        line-height: 1.2;
    }

    .header-content p {
        font-size: 0.8125rem;
        color: #6b7280;
        margin: 2px 0 0 0;
    }

    .subscription-body {
        padding: 24px;
    }

    .info-box {
        background: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 12px;
        padding: 14px 16px;
        margin-bottom: 24px;
        display: flex;
        align-items: flex-start;
        gap: 12px;
    }

    .info-box i {
        color: #0284c7;
        font-size: 1.125rem;
        margin-top: 2px;
        flex-shrink: 0;
    }

    .info-box p {
        margin: 0;
        color: #0c4a6e;
        line-height: 1.5;
        font-size: 0.875rem;
    }

    .subscription-details {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        padding: 20px;
        border-radius: 16px;
        margin-bottom: 24px;
    }

    .detail-row {
        display: flex;
        flex-direction: column;
        padding: 14px 0;
        border-bottom: 1px solid #e5e7eb;
        gap: 6px;
    }

    .detail-row:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }

    .detail-label {
        font-weight: 600;
        color: #374151;
        font-size: 0.8125rem;
        display: flex;
        align-items: center;
        gap: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .detail-label i {
        font-size: 0.9375rem;
        color: #6b7280;
    }

    .detail-value {
        color: #111827;
        font-size: 0.9375rem;
        font-weight: 500;
        word-break: break-word;
        margin-left: 28px;
    }

    .package-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .package-badge.basic {
        background: #dbeafe;
        color: #1e40af;
    }

    .package-badge.premium {
        background: #fef3c7;
        color: #92400e;
    }

    .package-badge.enterprise {
        background: #e9d5ff;
        color: #6b21a8;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: capitalize;
    }

    .status-badge.active {
        background: #d1fae5;
        color: #166534;
    }

    .status-badge.inactive {
        background: #fee2e2;
        color: #991b1b;
    }

    .billing-cycle {
        text-transform: capitalize;
        font-weight: 500;
    }

    .amount-display {
        font-size: 1.5rem;
        font-weight: 700;
        color: #10b981;
    }

    .currency {
        font-size: 1rem;
        color: #6b7280;
        margin-right: 4px;
    }

    .proceed-button {
        background: #10b981;
        border: none;
        border-radius: 12px;
        padding: 16px 24px;
        font-size: 1rem;
        font-weight: 600;
        color: white;
        width: 100%;
        transition: all 0.2s ease;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        cursor: pointer;
        min-height: 48px;
    }

    .proceed-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
        background: #059669;
    }

    .proceed-button:active {
        transform: translateY(0);
    }

    .proceed-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    /* Tablet and Desktop Styles */
    @media (min-width: 768px) {
        .subscription-container {
            padding: 24px;
        }

        .subscription-header {
            padding: 24px 32px;
        }

        .header-icon {
            width: 48px;
            height: 48px;
            font-size: 24px;
        }

        .header-content h1 {
            font-size: 1.5rem;
        }

        .header-content p {
            font-size: 0.875rem;
        }

        .subscription-body {
            padding: 32px;
        }

        .subscription-details {
            padding: 28px;
        }

        .detail-row {
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            gap: 0;
            padding: 16px 0;
        }

        .detail-label {
            font-size: 0.875rem;
        }

        .detail-value {
            font-size: 1rem;
            margin-left: 0;
            text-align: right;
        }

        .amount-display {
            font-size: 2rem;
        }

        .currency {
            font-size: 1.25rem;
        }

        .proceed-button {
            padding: 18px 40px;
            font-size: 1.0625rem;
        }

        .info-box {
            padding: 16px 20px;
        }

        .info-box p {
            font-size: 0.9375rem;
        }
    }

    /* Large Desktop */
    @media (min-width: 1024px) {
        .subscription-card {
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        }
    }
</style>

<div class="subscription-container">
    <div class="subscription-card">
        <div class="subscription-header">
            <div class="header-left">
                <div class="header-icon">
                    <i class="bi bi-credit-card"></i>
                </div>
                <div class="header-content">
                    <h1>Subscription Details</h1>
                    <p>Review and proceed to payment</p>
                </div>
            </div>
        </div>
        
        <div class="subscription-body">
            <div class="info-box">
                <p>
                    <i class="bi bi-info-circle me-2"></i>
                    Please review your subscription details below and proceed to payment when ready.
                </p>
            </div>

            <div class="subscription-details">
                <div class="detail-row">
                    <span class="detail-label">
                        <i class="bi bi-person me-2"></i>User ID
                    </span>
                    <span class="detail-value" id="userIdDisplay">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">
                        <i class="bi bi-envelope me-2"></i>Email
                    </span>
                    <span class="detail-value" id="emailDisplay">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">
                        <i class="bi bi-telephone me-2"></i>Phone
                    </span>
                    <span class="detail-value" id="phoneDisplay">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">
                        <i class="bi bi-box-seam me-2"></i>Package
                    </span>
                    <span class="detail-value">
                        <span class="package-badge" id="packageBadge">-</span>
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">
                        <i class="bi bi-calendar me-2"></i>Billing Cycle
                    </span>
                    <span class="detail-value billing-cycle" id="billingCycleDisplay">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">
                        <i class="bi bi-check-circle me-2"></i>Status
                    </span>
                    <span class="detail-value">
                        <span class="status-badge" id="statusBadge">-</span>
                    </span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">
                        <i class="bi bi-currency-dollar me-2"></i>Amount
                    </span>
                    <span class="detail-value">
                        <span class="amount-display">
                            <span class="currency">â‚¦</span><span id="amountDisplay">-</span>
                        </span>
                    </span>
                </div>
            </div>
            
            <button type="button" class="proceed-button" id="proceedButton">
                <i class="bi bi-lock-fill"></i>
                <span>Proceed to Payment</span>
            </button>
            
            <div id="errorMessage" class="alert alert-danger d-none mt-3" role="alert">
                <i class="bi bi-exclamation-circle me-2"></i>
                <span></span>
            </div>
        </div>
    </div>
</div>

<script>
    // Subscription data from server
    // Safely handle undefined/null values for production
    const subscriptionData = <%- JSON.stringify({
        userId: (typeof userId !== 'undefined' && userId !== null) ? String(userId) : '',
        userEmail: (typeof userEmail !== 'undefined' && userEmail !== null) ? String(userEmail) : '',
        userPhone: (typeof userPhone !== 'undefined' && userPhone !== null) ? String(userPhone) : '',
        status: (typeof status !== 'undefined' && status !== null) ? String(status) : '',
        package: (typeof package !== 'undefined' && package !== null) ? String(package) : '',
        billingCycle: (typeof billingCycle !== 'undefined' && billingCycle !== null) ? String(billingCycle) : '',
        amount: (typeof amount !== 'undefined' && amount !== null) ? String(amount) : ''
    }) %>;
    
    // Debug: Log subscription data received from server
    console.log('[CLIENT] Subscription data from server:', subscriptionData);

    // Get URL parameters (fallback to URL if server data is empty)
    function getUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);
        return {
            userId: subscriptionData.userId || urlParams.get('userId') || '',
            userEmail: subscriptionData.userEmail || '',
            userPhone: subscriptionData.userPhone || '',
            status: subscriptionData.status || urlParams.get('status') || '',
            package: subscriptionData.package || urlParams.get('package') || '',
            billingCycle: subscriptionData.billingCycle || urlParams.get('billingCycle') || '',
            amount: subscriptionData.amount || urlParams.get('amount') || ''
        };
    }

    // Format package name
    function formatPackageName(pkg) {
        if (!pkg) return '-';
        return pkg.charAt(0).toUpperCase() + pkg.slice(1);
    }

    // Format billing cycle
    function formatBillingCycle(cycle) {
        if (!cycle) return '-';
        const cycles = {
            'monthly': 'Monthly',
            'quarterly': 'Quarterly',
            'semi-annual': 'Semi-Annual',
            'yearly': 'Yearly',
            'annual': 'Annual'
        };
        return cycles[cycle.toLowerCase()] || cycle;
    }

    // Format amount
    function formatAmount(amount) {
        if (!amount) return '0.00';
        const numAmount = parseFloat(amount);
        return isNaN(numAmount) ? '0.00' : numAmount.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    // Get package badge class
    function getPackageBadgeClass(pkg) {
        if (!pkg) return 'basic';
        const pkgLower = pkg.toLowerCase();
        if (pkgLower.includes('premium') || pkgLower.includes('pro')) return 'premium';
        if (pkgLower.includes('enterprise')) return 'enterprise';
        return 'basic';
    }

    // Fetch user email from API if missing
    async function fetchUserEmail(userId) {
        if (!userId) {
            console.log('[CLIENT] fetchUserEmail: No userId provided');
            return null;
        }
        
        console.log('[CLIENT] fetchUserEmail: Attempting to fetch email for userId:', userId);
        
        // Use absolute URL for production compatibility
        const baseUrl = window.location.origin;
        const apiUrl = `${baseUrl}/api/auth/user/email/${encodeURIComponent(userId)}`;
        console.log('[CLIENT] fetchUserEmail: API URL:', apiUrl);
        
        try {
            // Create abort controller for timeout (compatible with older browsers)
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
            
            const response = await fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            console.log('[CLIENT] fetchUserEmail: Response status:', response.status);
            console.log('[CLIENT] fetchUserEmail: Response ok:', response.ok);
            console.log('[CLIENT] fetchUserEmail: Response headers:', Object.fromEntries(response.headers.entries()));
            
            if (response.ok) {
                const data = await response.json();
                console.log('[CLIENT] fetchUserEmail: Response data:', data);
                if (data.success && data.email) {
                    console.log('[CLIENT] fetchUserEmail: Successfully fetched email:', data.email);
                    return data.email;
                } else {
                    console.warn('[CLIENT] fetchUserEmail: Response successful but no email found:', data);
                }
            } else {
                // Try to get error message from response
                let errorData;
                try {
                    errorData = await response.json();
                } catch (e) {
                    errorData = { message: `HTTP ${response.status}: ${response.statusText}` };
                }
                console.error('[CLIENT] fetchUserEmail: API error response:', response.status, errorData);
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                console.error('[CLIENT] fetchUserEmail: Request timeout after 10 seconds');
            } else {
                console.error('[CLIENT] fetchUserEmail: Network or parsing error:', error);
                console.error('[CLIENT] fetchUserEmail: Error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
            }
        }
        return null;
    }

    // Display subscription details
    async function displaySubscriptionDetails() {
        const params = getUrlParams();
        console.log('displaySubscriptionDetails: Initial params:', params);
        console.log('displaySubscriptionDetails: subscriptionData from server:', subscriptionData);
        
        // Check if required parameters are present
        if (!params.userId || !params.package || !params.amount) {
            showError('Missing required subscription parameters. Please check the URL.');
            document.getElementById('proceedButton').disabled = true;
            return;
        }

        // Display values
        document.getElementById('userIdDisplay').textContent = params.userId || '-';
        
        // If email is missing, try to fetch it
        let displayEmail = params.userEmail;
        let displayPhone = params.userPhone;
        
        console.log('displaySubscriptionDetails: Initial email from params:', displayEmail);
        console.log('displaySubscriptionDetails: Initial email from subscriptionData:', subscriptionData.userEmail);
        
        if (!displayEmail) {
            console.log('displaySubscriptionDetails: Email is missing, attempting to fetch...');
            document.getElementById('emailDisplay').textContent = 'Loading...';
            const fetchedEmail = await fetchUserEmail(params.userId);
            if (fetchedEmail) {
                displayEmail = fetchedEmail;
                // Update subscriptionData for later use
                subscriptionData.userEmail = fetchedEmail;
                console.log('displaySubscriptionDetails: Successfully fetched and set email:', fetchedEmail);
            } else {
                console.warn('displaySubscriptionDetails: Failed to fetch email, will show "Not available"');
            }
        } else {
            console.log('displaySubscriptionDetails: Email already available:', displayEmail);
        }
        
        document.getElementById('emailDisplay').textContent = displayEmail || 'Not available';
        document.getElementById('phoneDisplay').textContent = displayPhone || 'Not available';
        document.getElementById('packageBadge').textContent = formatPackageName(params.package);
        document.getElementById('packageBadge').className = `package-badge ${getPackageBadgeClass(params.package)}`;
        document.getElementById('billingCycleDisplay').textContent = formatBillingCycle(params.billingCycle);
        document.getElementById('statusBadge').textContent = params.status || 'pending';
        document.getElementById('statusBadge').className = `status-badge ${params.status === 'active' ? 'active' : 'inactive'}`;
        document.getElementById('amountDisplay').textContent = formatAmount(params.amount);
    }

    // Show error message
    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        const errorSpan = errorDiv.querySelector('span');
        if (errorSpan) {
            errorSpan.textContent = message;
        } else {
            errorDiv.textContent = message;
        }
        errorDiv.classList.remove('d-none');
    }

    // Handle proceed to payment
    async function handleProceedToPayment() {
        const params = getUrlParams();
        
        // Validate required parameters
        if (!params.userId || !params.package || !params.amount) {
            showError('Missing required subscription parameters. Cannot proceed to payment.');
            return;
        }

        // If email is still missing, try to fetch it one more time
        let userEmail = params.userEmail;
        if (!userEmail) {
            userEmail = await fetchUserEmail(params.userId);
            if (userEmail) {
                subscriptionData.userEmail = userEmail;
            }
        }

        if (!userEmail) {
            showError('User email is required for payment. Please ensure the user exists in the system.');
            return;
        }

        // Disable button and show loading
        const button = document.getElementById('proceedButton');
        button.disabled = true;
        const originalHTML = button.innerHTML;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span><span>Initializing Payment...</span>';

        try {
            // Initialize Flutterwave payment
            const response = await fetch('/api/payment/initialize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    userId: params.userId,
                    userEmail: userEmail,
                    userPhone: params.userPhone || '',
                    package: params.package,
                    billingCycle: params.billingCycle || 'monthly',
                    amount: params.amount,
                    status: params.status || 'pending'
                })
            });

            const data = await response.json();

            if (data.success && data.paymentLink) {
                // Redirect to Flutterwave checkout
                window.location.href = data.paymentLink;
            } else {
                throw new Error(data.message || 'Failed to initialize payment');
            }
        } catch (error) {
            console.error('Payment initialization error:', error);
            showError(error.message || 'Failed to initialize payment. Please try again.');
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        displaySubscriptionDetails();
        
        // Add click handler to proceed button
        document.getElementById('proceedButton').addEventListener('click', handleProceedToPayment);
    });
</script>

<%- include('partials/footer') %>

